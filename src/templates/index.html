<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Studio Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; margin-bottom: 10px; resize: vertical; min-height: 100px; max-height: 300px; }
        #result, #debug { white-space: pre-wrap; background-color: #f0f0f0; padding: 10px; border-radius: 5px; min-height: 100px; margin-top: 10px; }
        #modelInfo { margin-bottom: 10px; font-style: italic; }
        #status { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>LM Studio Interface</h1>
    <div id="modelInfo">Loading model information...</div>
    <textarea id="prompt" placeholder="Enter your prompt here..."></textarea>
    <br>
    <button onclick="generateText()">Generate</button>
    <button id="stopButton" onclick="stopGeneration()" disabled>Stop Generation</button>
    <div id="status"></div>
    <h2>Generated Text:</h2>
    <div id="result"></div>
    <h2>Debug Info:</h2>
    <div id="debug"></div>

    <script>
        let controller = null;

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function generateText() {
            const prompt = document.getElementById('prompt').value;
            const resultDiv = document.getElementById('result');
            const debugDiv = document.getElementById('debug');
            const statusDiv = document.getElementById('status');
            resultDiv.innerHTML = 'Generating...';
            debugDiv.innerHTML = 'Debug info will appear here...';
            statusDiv.innerHTML = 'Generating...';
            document.getElementById('stopButton').disabled = false;

            controller = new AbortController();
            const signal = controller.signal;

            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt }),
                signal: signal
            })
            .then(response => {
                const reader = response.body.getReader();
                return new ReadableStream({
                    start(controller) {
                        return pump();
                        function pump() {
                            return reader.read().then(({ done, value }) => {
                                if (done) {
                                    controller.close();
                                    return;
                                }
                                controller.enqueue(value);
                                return pump();
                            });
                        }
                    }
                });
            })
            .then(stream => new Response(stream))
            .then(response => response.text())
            .then(data => {
                debugDiv.innerHTML = `Raw response: ${escapeHtml(data)}`;
                let generatedText = '';
                const lines = data.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const content = line.slice(6).trim();  // Remove 'data: ' and trim
                        if (content === '[DONE]') {
                            debugDiv.innerHTML += '\nGeneration complete.';
                            statusDiv.innerHTML = 'Generation complete.';
                            continue;
                        }
                        try {
                            const jsonData = JSON.parse(content);
                            debugDiv.innerHTML += `\nParsed JSON: ${JSON.stringify(jsonData)}`;
                            if (jsonData.choices && jsonData.choices[0].text) {
                                generatedText += jsonData.choices[0].text;
                            } else if (jsonData.debug) {
                                debugDiv.innerHTML += `\nDebug: ${jsonData.debug}`;
                            }
                            if (jsonData.choices && jsonData.choices[0].finish_reason === "stop") {
                                statusDiv.innerHTML = 'Generation complete.';
                            }
                        } catch (e) {
                            debugDiv.innerHTML += `\nError parsing JSON: ${e}`;
                        }
                    }
                }
                resultDiv.innerHTML = escapeHtml(generatedText.trim());  // Trim to remove leading/trailing whitespace
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted');
                    debugDiv.innerHTML += '\nFetch aborted';
                    statusDiv.innerHTML = 'Generation stopped.';
                } else {
                    console.error('Error:', error);
                    debugDiv.innerHTML += `\nError: ${error}`;
                    resultDiv.innerHTML = 'An error occurred while generating the text.';
                    statusDiv.innerHTML = 'Error occurred.';
                }
            })
            .finally(() => {
                document.getElementById('stopButton').disabled = true;
                controller = null;
            });
        }

        function stopGeneration() {
            if (controller) {
                controller.abort();
                document.getElementById('stopButton').disabled = true;
            }
        }

        // Fetch model information
        fetch('/model_info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('modelInfo').textContent = `Loaded model: ${data.model_name}`;
            })
            .catch(error => {
                console.error('Error fetching model info:', error);
                document.getElementById('modelInfo').textContent = 'Unable to fetch model information';
            });
    </script>
</body>
</html>